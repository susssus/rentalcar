name: Daily price scrape

on:
  schedule:
    # Noon UTC daily
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium || true

      - name: Run scraper and ingest
        env:
          INGEST_URL: ${{ secrets.INGEST_URL }}
          INGEST_SECRET: ${{ secrets.INGEST_SECRET }}
        run: |
          set -e
          echo "=== 1. Running scraper ==="
          OUT=$(python scripts/run_and_output_json.py 2>&1) || true
          echo "Scraper stdout/stderr (first 800 chars):"
          echo "$OUT" | head -c 800
          echo ""

          if [ -z "$INGEST_URL" ] || [ -z "$INGEST_SECRET" ]; then
            echo "=== FAIL: INGEST_URL or INGEST_SECRET not set in repo Secrets. Add them in Settings → Secrets and variables → Actions. ==="
            exit 1
          fi

          if ! echo "$OUT" | python3 -c "import sys,json; d=json.load(sys.stdin); exit(0 if d.get('pickup_date') else 1)" 2>/dev/null; then
            echo "=== FAIL: Scraper did not return valid JSON with pickup_date (maybe it crashed or timed out). Check the scraper output above. ==="
            exit 1
          fi

          BASE="${INGEST_URL%/}"
          INGEST="${BASE}/api/ingest"
          echo "=== 2. POSTing to $INGEST ==="
          HTTP=$(curl -sS -w "%{http_code}" -o /tmp/ingest_resp -X POST "$INGEST" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $INGEST_SECRET" \
            -d "$OUT")
          echo "Response ($HTTP):"
          cat /tmp/ingest_resp
          echo ""

          if [ "$HTTP" != "200" ]; then
            echo "=== FAIL: Ingest returned HTTP $HTTP. If 401: INGEST_SECRET in GitHub must match CRON_SECRET or INGEST_SECRET in Vercel. If 500: check Vercel logs / Redis. ==="
            exit 1
          fi
          echo "=== Done: data was stored. Refresh your dashboard. ==="
